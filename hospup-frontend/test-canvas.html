<!DOCTYPE html>
<html>
<head>
    <title>Test Canvas Video Capture</title>
</head>
<body>
    <h1>Test Canvas Video Capture</h1>
    <canvas id="testCanvas" width="1080" height="1920" style="border: 1px solid black; width: 200px; height: 356px;"></canvas>
    <br><br>
    <button onclick="testCapture()">Test Capture 3s</button>
    <div id="result"></div>

    <script>
        const canvas = document.getElementById('testCanvas');
        const ctx = canvas.getContext('2d');

        // Dessiner quelque chose d'anim√© sur le canvas
        let frame = 0;
        function drawFrame() {
            // Fond noir
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Rectangle anim√©
            ctx.fillStyle = '#ff0000';
            const x = (Math.sin(frame * 0.1) + 1) * canvas.width * 0.3;
            const y = (Math.cos(frame * 0.1) + 1) * canvas.height * 0.3;
            ctx.fillRect(x, y, 200, 200);

            // Texte
            ctx.fillStyle = '#ffffff';
            ctx.font = '48px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`Frame ${frame}`, canvas.width/2, canvas.height/2);

            frame++;
        }

        // Animation continue
        setInterval(drawFrame, 33); // ~30 FPS

        async function testCapture() {
            try {
                console.log('üöÄ Starting test capture...');

                // Cr√©er stream depuis canvas
                const stream = canvas.captureStream(30);
                console.log('‚úÖ Canvas stream created');

                // MediaRecorder
                const mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm;codecs=vp9',
                    videoBitsPerSecond: 2500000
                });

                const chunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        chunks.push(event.data);
                        console.log(`üì¶ Chunk: ${event.data.size} bytes`);
                    }
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    console.log(`‚úÖ Video generated: ${blob.size} bytes`);

                    // Cr√©er lien de t√©l√©chargement
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `test-canvas-${Date.now()}.webm`;
                    a.textContent = 'T√©l√©charger la vid√©o de test';

                    const resultDiv = document.getElementById('result');
                    resultDiv.innerHTML = `<p>Vid√©o g√©n√©r√©e: ${blob.size} bytes</p>`;
                    resultDiv.appendChild(a);
                };

                mediaRecorder.onerror = (error) => {
                    console.error('‚ùå MediaRecorder error:', error);
                    document.getElementById('result').innerHTML = `<p style="color: red;">Erreur: ${error}</p>`;
                };

                // Start recording
                mediaRecorder.start(250);
                console.log('üé¨ Recording started for 3s...');

                // Stop after 3s
                setTimeout(() => {
                    mediaRecorder.stop();
                    console.log('üõë Recording stopped');
                }, 3000);

            } catch (error) {
                console.error('‚ùå Test failed:', error);
                document.getElementById('result').innerHTML = `<p style="color: red;">Test failed: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>